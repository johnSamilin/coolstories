<!DOCTYPE html><html lang="ru"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.704c04d836308418f5f5.css">@import url(https://fonts.googleapis.com/css2?family=Forum&display=swap);
/*! bettertext.css v2.0.4 | MIT License | github.com/paulradzkov/bettertext.css */body,h1,h2,h3,h4,h5,h6{font-family:sans-serif}body,h5{line-height:1.5}b,dl:not([class]) dt:not([class]),dt,h1,h2,h3,h4,h5,h6,strong{font-weight:bolder}abbr,h6{letter-spacing:.05em}body{font-size:1em}article:not([class]),body:not([class]),section:not([class]){margin:calc(24px + 4vh) calc(10px + 4vw)}article:not([class]) article:not([class]),article:not([class]) section:not([class]),body:not([class]) article:not([class]),body:not([class]) section:not([class]),section:not([class]) article:not([class]),section:not([class]) section:not([class]){margin-left:0;margin-right:0}p{margin:0 0 1.5em;max-width:50rem}ol:not([class]):before,p:before,ul:not([class]):before{content:"";display:block;width:10em;overflow:hidden}li p:before{content:none}h1{font-size:1.625em;line-height:1.1;margin:3.23076923em 0 .92307692em}h2{font-size:1.4375em;line-height:1.2;margin:3.13043478em 0 1.04347826em}h3{font-size:1.25em;line-height:1.3;margin:3em 0 1.2em}h4{font-size:1.125em;line-height:1.4;margin:2.66666667em 0 1.33333333em}h5{font-size:1em;margin:2.25em 0 1.5em}h6{font-size:.75em;line-height:2;margin:2em 0 0;text-transform:uppercase}@media (min-width:768px){h1{font-size:2.4375em;margin-top:3.07692308em;margin-bottom:.61538462em}h2{font-size:1.9375em;margin-top:3.09677419em;margin-bottom:.77419355em}h3{font-size:1.5625em;margin-top:2.88em;margin-bottom:.96em}h4{font-size:1.25em;margin-top:2.4em;margin-bottom:1.2em}}h1:first-child,h2:first-child,h3:first-child,h4:first-child,h5:first-child,h6:first-child{margin-top:0}h1+h2{margin-top:1.2em}h2+h3{margin-top:1.3em}h3+h4{margin-top:1.4em}h4+h5{margin-top:1.5em}h5+h6{margin-top:2em}ol:not([class]),ul:not([class]){margin:0 0 1.5em;max-width:47.5rem;padding-left:0;padding-right:2.5em}blockquote>p:last-child,ol:not([class]) ol,ol:not([class]) ul,ul:not([class]) ol,ul:not([class]) ul{margin-bottom:0}ol:not([class]) li,ul:not([class]) li{transform:translateX(2.5em);animation:fixlists 1s}@keyframes fixlists{0%{text-indent:-.001em}to{text-indent:0}}img{max-width:100%;height:auto;vertical-align:bottom}p img:not(:only-child){vertical-align:baseline}figure:not([class]){margin:3em 0}figure:not([class])>p{max-width:37.5rem;font-size:.75em;margin:.5em 0 0}dl:not([class]),hr:not([class]){max-width:50rem}figcaption{max-width:37.5rem;font-size:.75em;margin:.5em 0 3em}figcaption>p{margin:.5em 0 0}blockquote,dl:not([class]),dl:not([class]) dd:not([class]){margin:0 0 1.5em}blockquote{max-width:45rem;padding:1.5em 2.5em}blockquote>cite,blockquote>footer{display:block;font-size:.75em}pre{margin:1.5em 0;white-space:pre-wrap}p code{line-break:loose;overflow-wrap:break-word}table:not([class]){margin-top:3em;margin-bottom:3em;border-collapse:separate;border-spacing:0}table:not([class]) caption{text-align:left;font-size:.75em;margin-bottom:.625em}table:not([class]) td,table:not([class]) th{padding:.5em 1em;text-align:left;vertical-align:top;border:solid rgba(0,0,0,.1);border-width:0 0 1px}table:not([class]) thead td,table:not([class]) thead th{vertical-align:bottom;border-bottom-width:2px}hr:not([class]){border:0;border-bottom:1px solid;margin:1.5em 0;opacity:.1}abbr{margin-right:-.05em}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}.lang-selector{position:fixed;top:10px;right:10px;z-index:10}.index-page nav{position:relative;left:35%;top:15%;width:-webkit-max-content;width:max-content;z-index:1}.index-page svg{position:absolute;left:35%;top:5%;z-index:0}.index-page canvas{position:absolute;left:30px;bottom:30px;z-index:0}.index-page ul{margin:0;padding:0;display:flex;flex-direction:column-reverse}.index-page li,.index-page ul{width:-webkit-max-content;width:max-content}.index-page li{list-style:decimal-leading-zero;font-size:3rem;color:#000}.index-page li a{text-decoration:none;background:#fff}.index-page li a:hover{text-decoration:underline}.index-page header{font-size:2rem;position:absolute;bottom:175px;left:30px;transform:rotate(-30deg)}.date{font-style:italic;text-align:right}.pathfinding-page article{position:absolute;z-index:1;left:50%;right:0;top:0;background:#fff;margin-top:0;margin-bottom:0;padding-top:calc(24px + 4vh);padding-bottom:calc(24px + 4vh);padding-left:2rem}.pathfinding-page header{position:relative;z-index:1;color:#fff}.pathfinding-page .pathfinding-demo{position:fixed;top:0;left:0;width:100%;height:100%;background:#000}.pathfinding-page .date{font-style:italic;text-align:right}.pathfinding-page .lang-selector{position:relative;z-index:10;top:0;right:0}.pathfinding-page .lang-selector a{color:#fff}.forest-page body{overflow-x:hidden}.forest-page article{-webkit-columns:2;column-count:2}.forest-page .tree-on-box{height:450px;position:absolute;left:-120px;bottom:-195px;z-index:-1}.forest-page p.screen{display:inline-block;width:70%;margin:0 15% 24px}.forest-page .compare{position:relative}.forest-page .compare canvas{position:absolute;top:calc(50% - 75px);left:calc(50% - 50px)}.forest-page .lead{margin:calc(-24px - 4vh) calc(-10px - 4vw) auto;height:75vmin;overflow:hidden;position:relative}.forest-page .lead .gatsby-image-wrapper{position:absolute!important;overflow:hidden;height:75vmin;bottom:0;left:0;right:0;z-index:0;-webkit-filter:brightness(.65);filter:brightness(.65)}.forest-page .lead h1{z-index:1;color:#fff;font-size:50vmin;margin:0;line-height:1.25;font-family:Forum,cursive}.forest-page .lead h1,.forest-page .lead summary{position:relative;text-align:center;font-weight:100}.forest-page .lead summary{color:wheat;width:80vmin;margin:auto;font-size:2rem}.forest-page .lang-selector a{color:#fff}@media screen and (max-width:768px){.forest-page article{-webkit-columns:1;column-count:1}}@media screen and (max-width:375px){.forest-page .lead h1{font-size:40vmin}.forest-page .lead summary{font-size:1.2rem}}footer a{display:inline-block;margin-right:1rem}.strategy-page h1{letter-spacing:5rem}.strategy-page summary{font-size:larger}.strategy-page p{font-size:x-large;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto}.strategy-page article{-webkit-columns:2;column-count:2;-webkit-column-gap:3rem;column-gap:3rem}.strategy-page #path-illustration{float:right;margin-right:-20%;transform:scale(.9) translate(-10%);shape-outside:polygon(50% 0,90% 20%,100% 60%,75% 90%,50% 75%,20% 60%,15% 20%)}.strategy-page .gif-wrapper{display:flex;justify-content:space-around;align-items:center;margin:auto}.strategy-page .code{font-size:x-small;page-break-inside:avoid}.strategy-demo{width:100%;height:80vh}.strategy-demo .hints{text-align:center;width:100%}.hljs{display:block;overflow-x:auto;padding:.5em;background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><meta name="generator" content="Gatsby 2.23.6"/><title data-react-helmet="true">О поиске пути | Истории о разработке Webgl сцен</title><meta data-react-helmet="true" name="description" content="Это истории о том, как разработывать Webgl сцены для собственного удовольстия, без претензии на экспертизу"/><meta data-react-helmet="true" property="og:title" content="О поиске пути"/><meta data-react-helmet="true" property="og:description" content="Это истории о том, как разработывать Webgl сцены для собственного удовольстия, без претензии на экспертизу"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@johnSamilin"/><meta data-react-helmet="true" name="twitter:title" content="О поиске пути"/><meta data-react-helmet="true" name="twitter:description" content="Это истории о том, как разработывать Webgl сцены для собственного удовольстия, без претензии на экспертизу"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="preconnect dns-prefetch" href="https://mc.yandex.ru"/><link as="script" rel="preload" href="/webpack-runtime-e3df2ec66e17ab50d4b5.js"/><link as="script" rel="preload" href="/framework-357f6a8bee87bd15d980.js"/><link as="script" rel="preload" href="/app-53f5b1b75fd814613c9c.js"/><link as="script" rel="preload" href="/styles-89fd2ae28bdf06750a71.js"/><link as="script" rel="preload" href="/a61fe1925f16bdc1d97fb8a1e801f721b74519aa-7c7cb214c93d5f0fc121.js"/><link as="script" rel="preload" href="/d27d9d65b9b386233bef3942e5f3132349444b0b-a45a71449b8471e990b4.js"/><link as="script" rel="preload" href="/component---src-pages-pathfinding-js-af9cd1f83c4c2626a5ff.js"/><link as="fetch" rel="preload" href="/page-data\pathfinding\page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data\app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><main class="pathfinding-page"><div class="lang-selector"><a href="/en/pathfinding">in English</a></div><header class="lead"><h1>Поиск пути</h1><summary>Это история о том, что свой путь можно найти несколькими способами.</summary></header><iframe class="pathfinding-demo" frameBorder="0" src="/pathfinding-demo/index.html"></iframe><article><p class="letter">Когда я создал <a href="/forest">сцену с лесом</a> и добавил туда персонажа (которого, кстати, взял на<!-- --> <a href="https://www.mixamo.com/#/">Mixamo</a>), я подумал, что этот персонаж не может просто стоять на карте, как истукан, а должен уметь по ней передвигаться. Но не просто из точки А в точку Б, а с учетом препятствий. Раз уж наш пока что лирический герой находится в лесу, то должен уметь обходить деревья. Для меня это совершенно новый опыт и, возможно, люди, которые больше меня подкованы в теме разработки игр и алгоритмах, найдут этот текст дилетантским, но мне было интересно разбираться в том, как работает один из молотов, кующих разработчика, А*.</p><h2>A*</h2><p>Если представить поверхность, по которой нужно перемещаться персонажу, сеткой, то поиск пути от одной клетки до другой - это задача поиска в графе. Один из самых оптимальных способов это сделать - применить алгоритм, которому уже 62 года. Представим, что у каждой клетки есть некоторая проходимость - чем сложнее по ней передвигаться, тем выше стоимость передвижения. Некоторые клетки (те, на которых есть деревья), вообще непроходмы. Задача А* - найти такой путь, который будет иметь минимальную стоимость, то есть будет самым быстрым. Для этого для каждой клетки дополнительно еще используется эвристическая оценка, которая показывает, насколько перспективным решением будет пойти в ту или иную сторону.</p><p>Раз уж так получилось, что я занимаюсь фронтендом и мне интересны возможности веб-платформы, самым логичным шагом было начать с javascript-имплементации. Существует отличная библиотека<!-- --> <a href="http://qiao.github.io/PathFinding.js/visual/">PathFinding.js</a>, в которой собран десяток различных вариантов этого алгоритма и несколько видов эвристик. По ссылке можно посмотреть на статистику: сколько проходит итераций поиска, сколько он занимает времени. Самым оптимальным, на мой взгляд, был двунаправленный Best First Search с эвристикой Octile. Дополнительно он может свернуть путь до небольшого количества ключевых точек, определяющих, где находятся повороты.<!-- --> <a href="https://github.com/johnSamilin/forest/blob/pathfinding/src/utils/pathfinding/js.ts">Ссылка на код</a></p><p><strong>Профиль производительности js-версии</strong><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:49.375%"></div><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAKABQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABQADCf/EABcBAQEBAQAAAAAAAAAAAAAAAAQAAwL/2gAMAwEAAhADEAAAAdssgV2bPanzOSXlK//EABsQAAEEAwAAAAAAAAAAAAAAAAQAAQIUEBEy/9oACAEBAAEFAphk7pFqrJ0Nxj//xAAoEQABAgMECwAAAAAAAAAAAAABAgMABUEEERMUEBIhM1FlcoGRwdP/2gAIAQMBAT8BdcmocOXMvwiSQHE2rWSKC9Lwv2V4xjTzlni2feBm6qY7JX7XD++c6tP/xAAsEQABAQQEDwAAAAAAAAAAAAABAgADBBMFERQxEBUhIjRCU2FzgZGkssHU/9oACAECAQE/AbBR68r57Gl5rKFhzjeVEKhK6z03NiyidrHdh8TSIMXTecn06DQWiuOGPJWH/8QAJRAAAQIADwAAAAAAAAAAAAAAAQADEBMhIiMyM2KBkZKistLT/9oACAEBAAY/AqN2beiCcSG5SrUZN+KrDb1WniIf/8QAHBABAAEFAQEAAAAAAAAAAAAAAREAITFBYRBR/9oACAEBAAE/IXZn1JmlkQiUjkVMVy2nAFkU389H/9oADAMBAAIAAwAAABCraT//xAAdEQEBAAIDAAMAAAAAAAAAAAABESExAEFREHGB/9oACAEDAQE/EH2REUKININKpzMcc9KpDDsq+yYPv3iA51rg5BZl3fyba80ehgdABA8Dz5//xAAbEQEBAAMBAQEAAAAAAAAAAAABESExQQAQgf/aAAgBAgEBPxC5kmhnkAEumKTDzo5Lm4v6Lm90+ABgMdsYNCQOHYBAauqqyuVWivV+/wD/xAAcEAEBAAIDAQEAAAAAAAAAAAABESExAEFRkWH/2gAIAQEAAT8QMMnW51WUgF2BeYStmsYvYgxnvJ+ZUzqCTYHgM27Lo0HGzTUFuUJC7Z1ddcr6/XlfX68//9k=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/46b661737fc0fce7dfa7f496608debfe/836e2/profile-pathfinding-js.jpg 480w,
/static/46b661737fc0fce7dfa7f496608debfe/b1cc5/profile-pathfinding-js.jpg 960w,
/static/46b661737fc0fce7dfa7f496608debfe/e1744/profile-pathfinding-js.jpg 1918w" sizes="(max-width: 1918px) 100vw, 1918px" /><img loading="lazy" sizes="(max-width: 1918px) 100vw, 1918px" srcset="/static/46b661737fc0fce7dfa7f496608debfe/836e2/profile-pathfinding-js.jpg 480w,
/static/46b661737fc0fce7dfa7f496608debfe/b1cc5/profile-pathfinding-js.jpg 960w,
/static/46b661737fc0fce7dfa7f496608debfe/e1744/profile-pathfinding-js.jpg 1918w" src="/static/46b661737fc0fce7dfa7f496608debfe/e1744/profile-pathfinding-js.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></p><h2>А можно мощнее?</h2><p>Javascript - штука однопоточная, и если иметь дело с большой или запутанной картой, вычисления могут повлиять на отзывчивость интерфейса. Браузер и без того занят тем, что выполняет кучу работы по визуализации сцены каждые 16 миллисекунд, и правильным решением было бы ему помочь. Например, вынеся задачу поиска пути в отдельный поток, в воркер. По идее, это должно освободить основной поток для выполнения и планирования более важной работы.<!-- --> <a href="https://github.com/johnSamilin/forest/blob/pathfinding/src/utils/pathfinding/threaded.ts">Ссылка</a> <!-- -->на тот же самый код, что и в предыдущем примере, но уже перенесенный внурть <em>работника</em> (<a href="https://github.com/johnSamilin/forest/blob/pathfinding/src/utils/pathfinding/pathfinding.worker.ts">Github</a>).</p><p><strong>Профиль производительности worker-версии</strong><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:48.12500000000001%"></div><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAKABQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABQAECf/EABkBAQACAwAAAAAAAAAAAAAAAAQAAQIDBf/aAAwDAQACEAMQAAAB25wFUs7VKfN0FWapJ//EABsQAAIBBQAAAAAAAAAAAAAAAAEEAwAQERQy/9oACAEBAAEFApFJsaTdBaQBXi3/xAAmEQABAgQEBwEAAAAAAAAAAAABAxEAAgQSBSFBURATFCJDkcLT/9oACAEDAQE/AV58SBel6SW4lwoFmEuVoFqrkvqXjm49vhvqq/aAaxu6enu1aVZn18m8L5LKAZC75HH/xAApEQABAgQBDQEAAAAAAAAAAAABAgQAAxEhMgUQExQVNEFCUWSRocHU/9oACAECAQE/AQyYzLOFOVqHNRpVSuJVVvTphAjZuSO78MvyxqrMWGnoLDd/kkD1DAktJBJJJQak3ONef//EACYQAAEBBAoDAAAAAAAAAAAAAAECAAMRgRATISIxM0FScZGx0tP/2gAIAQEABj8CSHajZqqpUTyQiEZBsxPTv5MLwwGz1aSPFP8A/8QAHhABAAEEAgMAAAAAAAAAAAAAAREAITFBEFGB0fD/2gAIAQEAAT8ha1SZcuLKC7IdfY+lHTIA43gnyavTvNvLn//aAAwDAQACAAMAAAAQ0/A//8QAHBEBAQACAgMAAAAAAAAAAAAAAREhMQChEEFx/9oACAEDAQE/EE85TWCgIKVSnW/F3bRIsOPdO+JCVAkdQYFMySqyVt4QYAAAADSBgPnn/8QAHhEBAQEAAgEFAAAAAAAAAAAAAREhAEEQMVFhcfD/2gAIAQIBAT8QCNOpNixsVMFaaQnPk6/vF+sOx4Dj7A9BhdKBYC2QhxGQCFFsqqq9rvn/xAAbEAEBAQEAAwEAAAAAAAAAAAABESExABBRQf/aAAgBAQABPxAubShyBSapFwR8rRwuN7Gdw0/VEeeXn4exJQgguAFgHBKCqotX2XXr36+//9k=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/2a924a9735b2c908a4c5ed0fb92933b7/836e2/profile-pathfinding-threaded.jpg 480w,
/static/2a924a9735b2c908a4c5ed0fb92933b7/b1cc5/profile-pathfinding-threaded.jpg 960w,
/static/2a924a9735b2c908a4c5ed0fb92933b7/1bd3a/profile-pathfinding-threaded.jpg 1919w" sizes="(max-width: 1919px) 100vw, 1919px" /><img loading="lazy" sizes="(max-width: 1919px) 100vw, 1919px" srcset="/static/2a924a9735b2c908a4c5ed0fb92933b7/836e2/profile-pathfinding-threaded.jpg 480w,
/static/2a924a9735b2c908a4c5ed0fb92933b7/b1cc5/profile-pathfinding-threaded.jpg 960w,
/static/2a924a9735b2c908a4c5ed0fb92933b7/1bd3a/profile-pathfinding-threaded.jpg 1919w" src="/static/2a924a9735b2c908a4c5ed0fb92933b7/1bd3a/profile-pathfinding-threaded.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></p><h2>А еще мощнее?</h2><p>JS-версия, я уверен, использует все<!-- --> <a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e">возможности движка по оптимизации</a>, как например, hidden classes и кеширование, и при использовании TypeScript можно быть в той или иной степени уверенным в том, что параметры, передающиеся в методы <strong>PathFinding.js</strong>, будут всегда одного и того же типа. Это, в свою очередь, не будет приводить к их деоптимизации. Но еще интересней попробовать запустить этот процесс в WebAssembly с <em>near-native</em> скоростью. С точки зрения веб-технологий это еще более любопытно, потому что, несмотря на 10 лет своего существования, WebAssembly не используется так уж широко.</p><p>WebAssembly можно скомпилировать из десятка языков, включая C++, Go и Rust. Так как я не умею писать ни на одном из них, то можно просто найти готовое решение и скомпилировать его под свои нужды. Я выбрал Go, потому что... не знаю, просто попробовать. Благодаря отличному разбору<!-- --> <a href="https://www.aaron-powell.com/posts/2019-02-05-golang-wasm-2-writing-go/">Aaron Powell</a>, все оказалось не так уж и сложно и заняло буквально один день. Штука в том (и об этом есть упоминание в статье), что Wasm, скомпилированный из Go, ведет себя как отдельная подпрограмма. В ней можно использовать состояние и не инициализировать граф с препятствиями при каждом вызове. Учитывая, что в конкретно этой моей WebGL-сцене поиск пути выполняется при движении мыши над плоскостью, это может сэкономить некоторое количество ресурсов. Хотя этот же факт может привести к нежелательным последствиям:<ul><li>исключение, выброшенное внутри Wasm-модуля, означает, что поток, который не дает Go-скрипту завершиться, закрывается и повторная попытка вызвать какие-то из его функций будет неудачной;</li><li>Go не экспортирует никаких функций, он регистрирует обработчики в глобальной области видимости. Это может привести к конфликту имен;</li><li>то, что через все ту же глобальную область видимости он может манипулировать DOM, на мой взгляд, делает Go потенциально небезопасной штукой.</li></ul><a href="https://github.com/johnSamilin/go-pathfinding">Go-имплементация</a></p><p><strong>Профиль производительности go-версии</strong><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:49.16666666666667%"></div><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAKABQDAREAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUDBgn/xAAYAQADAQEAAAAAAAAAAAAAAAAAAwQBAv/aAAwDAQACEAMQAAAB2zXBGLa9U2Oe5jSs0//EABsQAAIBBQAAAAAAAAAAAAAAAAIEAQAQEhQy/9oACAEBAAEFAjTZmdJqhUPFbi3/xAArEQABAQQFDQAAAAAAAAAAAAABAgADBBMFERIxMhAUFSEzYWVxcoGRwdP/2gAIAQMBAT8BePaWCzm+j5V4mCLta78D4DvU02nOG+Iz7MgxpSC9MPMOOWHlivdbWVVcyz3ar6vQy//EACsRAAEBBQQKAwAAAAAAAAAAAAECAAMEEiEFEzFBEBEUFSI0U3FzkaTB1P/aAAgBAgEBPwEwFnPKvXkbPnLsPszwqqnE1A15Nu2yupHfA/GwhYJHCi/KU0BVczHvK6Sn0A0Fyjjx/ZYYaP/EACYQAAEBBAoDAAAAAAAAAAAAAAECAAMSkhAREyEiMTIzQbGistP/2gAIAQEABj8CEDzCAM7E1+HLbqZXfxZMagVAX6R0kdNL6in/xAAbEAEAAgIDAAAAAAAAAAAAAAABETEQISBBUf/aAAgBAQABPyGosJa6WoxbKATsDHCNwBQyMrQe/HAH/9oADAMBAAIAAwAAABDV6T//xAAcEQEAAgIDAQAAAAAAAAAAAAABESExQQAgUWH/2gAIAQMBAT8QJLDiSSiyBgElyqzzD5qtchFYym35wqoBA6QfLKmY30o//8QAHREBAAIDAAMBAAAAAAAAAAAAARExACFBEGGBsf/aAAgBAgEBPxDiggQCjKSBJAQtAgwd5FblPB27UIGADcZZc7ZK1vWJVVVCqyrert+5R9/Xx//EABsQAQEAAwEBAQAAAAAAAAAAAAERACFBMVGR/9oACAEBAAE/EGclhJ0K2SIIIKmVm7W/QaQ8c17FqPcnqEu0TKqp1ohzE23aU9ZOvZzK/X9cr9f1z//Z" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/45646f1433f95215a7dfd5af21a6a540/836e2/profile-pathfinding-go.jpg 480w,
/static/45646f1433f95215a7dfd5af21a6a540/b1cc5/profile-pathfinding-go.jpg 960w,
/static/45646f1433f95215a7dfd5af21a6a540/097fa/profile-pathfinding-go.jpg 1920w" sizes="(max-width: 1920px) 100vw, 1920px" /><img loading="lazy" sizes="(max-width: 1920px) 100vw, 1920px" srcset="/static/45646f1433f95215a7dfd5af21a6a540/836e2/profile-pathfinding-go.jpg 480w,
/static/45646f1433f95215a7dfd5af21a6a540/b1cc5/profile-pathfinding-go.jpg 960w,
/static/45646f1433f95215a7dfd5af21a6a540/097fa/profile-pathfinding-go.jpg 1920w" src="/static/45646f1433f95215a7dfd5af21a6a540/097fa/profile-pathfinding-go.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></p><h2>Еще!</h2><p>Чтобы <del>совсем упороться</del> не пренебрегать возможностями Wasm по управлению памятью, я решил пойти на эксперимент и написать рализацию А* самому на AssmeblyScript. Это версия TypeScript с чуть более строгими ограничениями и<!-- --> <a href="https://www.assemblyscript.org/stdlib/map.html#map">разницей в поведении базовых типов</a> <!-- -->(к примеру, <em>Map.keys()</em> возвращает не итератор, а массив ключей). В случае чего, AssmeblyScript-код можно довольно быстро преобразовать в TypeScript. Увидеть результат можно<!-- --> <a href="https://github.com/johnSamilin/assemblyscript-pathfinding">тут</a>.</p><p><strong>Профиль производительности AssembyScript-версии</strong><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:48.958333333333336%"></div><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAKABQDAREAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUEBgn/xAAXAQADAQAAAAAAAAAAAAAAAAAAAwQB/9oADAMBAAIQAxAAAAHbVUUYS32qzptZVLA//8QAHBAAAQMFAAAAAAAAAAAAAAAABAECAwAQERIy/9oACAEBAAEFApAp1pwBuEDfqNxb/8QAKBEAAgEBBgQHAAAAAAAAAAAAARECAwAEBRIhQRATFCIkMTNRYXGT/9oACAEDAQE/Aas8TzeGNxFMsqpTrsbADLUD03O9uZjmuuGfHZevP9Pe0esIBnK75ijJQmsy7ky02nat6s/vj//EACYRAAECBAMJAAAAAAAAAAAAAAEEEQACAyEUMZEFEBU0UVJzwdT/2gAIAQIBAT8BwCCpetOsNS7zApnmOZMzpzfSOG7J7l2qP5ow6IWlFZhYOaTsLB2ptl0tCLlKHj9nf//EACQQAAECBQIHAAAAAAAAAAAAAAECEQADEhMhMVEQI0FCcZKy/9oACAEBAAY/AhbmFhvaUT5NqFNOSFEGl0y9Ww/IPWE1LDhKQWbUDPZvHr8jj//EABsQAQEAAwADAAAAAAAAAAAAAAERACExEEFx/9oACAEBAAE/IdkhSnlRoFnshkEYCjGxRq0WnB1iBQ0wHYEJGnh8OZ08v//aAAwDAQACAAMAAAAQzlA//8QAHREBAQACAQUAAAAAAAAAAAAAAREhUQAQMWGB8P/aAAgBAwEBPxArUim9lImBtGjMGM4oFGpjBJgZ0euKUNCbByu2LJdvw+Dr/8QAHBEBAQACAgMAAAAAAAAAAAAAAREhMVFhABBB/9oACAECAQE/EFTdoyhhMtAgditXc8S2l5M9dTV35isHXqANQWCtAQMlcqKu3nfvv//EABkQAQEBAQEBAAAAAAAAAAAAAAERITFBEP/aAAgBAQABPxBcuVbIVG4bWEh6K5JJThhegTRgMJX1NAmcZCiAAAggAukNZCvvX7//2Q==" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/2b14e8aaf8a898682cabf90ef258f1a6/836e2/profile-pathfinding-as.jpg 480w,
/static/2b14e8aaf8a898682cabf90ef258f1a6/b1cc5/profile-pathfinding-as.jpg 960w,
/static/2b14e8aaf8a898682cabf90ef258f1a6/097fa/profile-pathfinding-as.jpg 1920w" sizes="(max-width: 1920px) 100vw, 1920px" /><img loading="lazy" sizes="(max-width: 1920px) 100vw, 1920px" srcset="/static/2b14e8aaf8a898682cabf90ef258f1a6/836e2/profile-pathfinding-as.jpg 480w,
/static/2b14e8aaf8a898682cabf90ef258f1a6/b1cc5/profile-pathfinding-as.jpg 960w,
/static/2b14e8aaf8a898682cabf90ef258f1a6/097fa/profile-pathfinding-as.jpg 1920w" src="/static/2b14e8aaf8a898682cabf90ef258f1a6/097fa/profile-pathfinding-as.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></p><h2>Как теперь с этим жить?</h2><p>Я надеялся, что простая миграция миграция кода с уровня браузера на уровен WebAssembly даст прирость производительности и избавит от головной боли по оптимизации. Но, как видно из скриншотов профилировщика, большой разницы нет. Wasm-версии работают даже немного хуже в периоды интенсивной деятельности. FPS снижается иногда до 1-2 кадров в секунду, и в это время сильно нагружен GPU. Эксперимент завершился, самый правильный выбор - полагаться на браузерный движок.</p><h3>Update</h3><p>Простые<!-- --> <a href="https://github.com/johnSamilin/assemblyscript-pathfinding/pull/1">оптимизации сборки</a> <!-- -->могут ускорить WebAssembly-версию в 4 раза. ¯\_(ツ)_/¯</p><h3>P.S.</h3><p><br/>Да, я знаю, он никуда не идет. Но ведь они никуда и не спешит :)</p><p class="date">13 июля 2020</p><footer><a href="/">Содержание</a><a href="mailto:alexandalexapps@outlook.com">Mail</a><a href="https://www.linkedin.com/in/asaltykov/">Linkedin</a><a href="https://github.com/johnSamilin">Github</a><a href="https://habr.com/ru/users/john_samilin/posts/">Habr</a></footer></article></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
  m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
  (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  ym(72750547, "init", {
      defer: true,
      clickmap:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:true,
      trackHash:true
  });
</script><noscript><div><img src="https://mc.yandex.ru/watch/72750547" style="position:absolute;left:-9999px" alt=""/></div></noscript><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/pathfinding/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-53f5b1b75fd814613c9c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-49a236dd939404d9a886.js"],"component---src-pages-en-index-js":["/component---src-pages-en-index-js-613f65a257ba1fe275cf.js"],"component---src-pages-en-pathfinding-js":["/component---src-pages-en-pathfinding-js-c591e22076a906166ac4.js"],"component---src-pages-en-strategy-js":["/component---src-pages-en-strategy-js-8ca56dcee2a0764b85e7.js"],"component---src-pages-forest-js":["/component---src-pages-forest-js-75ac0f9ab3d0958e9ab8.js"],"component---src-pages-index-js":["/component---src-pages-index-js-6f94c776884efd908b33.js"],"component---src-pages-pathfinding-js":["/component---src-pages-pathfinding-js-af9cd1f83c4c2626a5ff.js"],"component---src-pages-strategy-demo-js":["/component---src-pages-strategy-demo-js-e88c388ef530882584e5.js"],"component---src-pages-strategy-js":["/component---src-pages-strategy-js-e47390dd210e1d4a9c55.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-6e5f04c1773c3c2523a8.js"]};/*]]>*/</script><script src="/component---src-pages-pathfinding-js-af9cd1f83c4c2626a5ff.js" async=""></script><script src="/d27d9d65b9b386233bef3942e5f3132349444b0b-a45a71449b8471e990b4.js" async=""></script><script src="/a61fe1925f16bdc1d97fb8a1e801f721b74519aa-7c7cb214c93d5f0fc121.js" async=""></script><script src="/styles-89fd2ae28bdf06750a71.js" async=""></script><script src="/app-53f5b1b75fd814613c9c.js" async=""></script><script src="/framework-357f6a8bee87bd15d980.js" async=""></script><script src="/webpack-runtime-e3df2ec66e17ab50d4b5.js" async=""></script></body></html>